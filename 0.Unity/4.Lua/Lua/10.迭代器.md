[toc]

# Lua 迭代器遍历

Lua 提供 `ipairs` 和 `pairs` 两种迭代器用于遍历表（table），但两者在行为和适用场景上有显著差异。

---

## 一、基础示例与表结构

```lua
print("*********迭代器遍历*********")
a = {[0] = 1, 2, [-1] = 3, 4, 5, [5] = 6}
```

> **表结构说明**：
>
> - 包含默认索引（从 `1` 开始）：`a[1]=2`, `a[2]=4`, `a[3]=5`
> - 自定义索引：`a[0]=1`, `a[-1]=3`, `a[5]=6`
> - `#a` 计算长度时会忽略 `nil` 和非连续索引，输出为 `3`

---

## 二、`ipairs` 迭代器（顺序遍历）

```lua
print("*********ipairs迭代器遍历*********")
for i, v in ipairs(a) do
    print("ipairs遍历键值 " .. i .. "_" .. v)
end
```

> **输出结果**：
> ```
> ipairs遍历键值 1_2
> ipairs遍历键值 2_4
> ```

> **关键特性**：
>
> - 从索引 `1` 开始，按顺序递增遍历
> - **遇到 `nil` 或索引断开时立即终止**（如 `a[3]=5` 存在但 `a[4]` 为 `nil`）
> - **无法访问自定义索引**（如 `0`、`-1`、`5`）
> - 适用于**连续整数索引的数组**

---

## 三、`pairs` 迭代器（无序遍历）

```lua
print("*********pairs迭代器遍历*********")
for k, v in pairs(a) do
    print("pairs遍历键值 " .. k .. "_" .. v)
end
```

> **输出结果**（键值顺序可能随机）：
> ```
> pairs遍历键值 -1_3
> pairs遍历键值 0_1
> pairs遍历键值 1_2
> pairs遍历键值 2_4
> pairs遍历键值 3_5
> pairs遍历键值 5_6
> ```

> **关键特性**：
> - 遍历表中**所有键值对**（包括自定义索引）
> - **键值顺序不确定**（基于哈希表实现）
> - 适用于**任意类型的键**（整数、字符串、负数等）
> - 可单独遍历键：
>   ```lua
>   for k in pairs(a) do
>       print("pairs遍历键 " .. k)
>   end
>   ```

---

## 四、`ipairs` 与 `pairs` 对比总结

| 特性     | `ipairs`                      | `pairs`                  |
| -------- | ----------------------------- | ------------------------ |
| 遍历方式 | 从 `1` 开始递增遍历           | 遍历所有键值对           |
| 索引要求 | 必须是连续整数索引            | 支持任意类型的键         |
| 终止条件 | 遇到 `nil` 或索引断开立即终止 | 遍历完整个表             |
| 顺序性   | 保持索引顺序                  | 顺序不确定               |
| 适用场景 | 遍历数组（连续整数索引）      | 遍历字典、混合索引表     |
| 性能     | 更快（底层用数组实现）        | 较慢（底层用哈希表实现） |

---

## 五、常见注意事项

### 1. `ipairs` 的局限性
```lua
a = {1, nil, 3}
for i, v in ipairs(a) do
    print(i, v)  -- 仅输出: 1 1（遇到 nil 后终止）
end
```

### 2. `pairs` 的无序性
```lua
t = {a = 1, b = 2, c = 3}
for k, v in pairs(t) do
    print(k, v)  -- 输出顺序可能为 a, c, b 或其他
end
```

### 3. `#` 运算符的不准确性
```lua
a = {1, 2, nil, 4}
print(#a)  -- 输出: 2（忽略 nil）
```

---



## 六、总结

| 场景                 | 推荐迭代器 | 说明                      |
| -------------------- | ---------- | ------------------------- |
| 遍历连续数组         | `ipairs`   | 快速且保持顺序            |
| 遍历字典或混合索引表 | `pairs`    | 支持任意键                |
| 需要访问所有键值对   | `pairs`    | `ipairs` 会遗漏自定义索引 |
| 需要性能优化         | `ipairs`   | 底层用数组实现，效率更高  |

> **提示**：理解 `ipairs` 和 `pairs` 的行为差异是掌握 Lua 表遍历的关键。
>
> 根据实际需求选择合适的迭代器，避免因索引问题导致逻辑错误。