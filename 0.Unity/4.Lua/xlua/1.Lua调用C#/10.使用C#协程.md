[toc]

# Lua 调用 C# 协程

## 一、协程调用基础

> **核心机制**：Lua 协程与 C# 协程语法不同，需通过 `xlua.util.cs_generator` 转换 Lua 函数为 C# 可识别的 `IEnumerator`。

---

### 1. 引入必要模块
```lua
-- 必须通过 require 加载 util 模块
util = require("xlua.util")

-- 引入 Unity 类型
GameObject = CS.UnityEngine.GameObject
WaitForSeconds = CS.UnityEngine.WaitForSeconds
```

> **关键点**：
>
> - `util.cs_generator` 是 XLua 提供的专用工具，用于转换 Lua 协程函数
> - `WaitForSeconds` 是 C# 的协程等待器
---

### 2. 创建 GameObject 并绑定组件
```lua
local obj = GameObject("Coroutine")
local mono = obj:AddComponent(typeof(CS.LuaCallCsharp.LuaCallCsharp))
```

> **注意**：
>
> - `LuaCallCsharp` 是自定义的 C# MonoBehavior 脚本
> - `mono` 是 C# 脚本的引用，用于调用 `StartCoroutine` 和 `StopCoroutine`
---

## 二、定义并启动协程

### 1. 定义 Lua 协程函数
```lua
fun = function()
    local a = 1
    while true do
        -- 使用 coroutine.yield 暂停协程
        coroutine.yield(WaitForSeconds(1))
        print(a)
        a = a + 1
        if a > 3 then
            mono:StopCoroutine(b) -- 停止协程
        end
    end
end
```

> **关键规则**：
>
> - **Lua 中不能直接使用 `yield return`**，必须通过 `coroutine.yield` 暂停
> - **等待器类型必须是 C# 的 `YieldInstruction`**（如 `WaitForSeconds`）
---

### 2. 启动协程
```lua
-- 将 Lua 函数转换为 C# IEnumerator
b = mono:StartCoroutine(util.cs_generator(fun))
```

> **核心转换**：
>
> - `util.cs_generator(fun)` 将 Lua 协程函数转换为 `IEnumerator`。
> - `StartCoroutine` 接收 `IEnumerator` 并启动协程。
---

## 三、停止协程

### 1. 通过 `StopCoroutine` 停止
```lua
if a > 3 then
    mono:StopCoroutine(b) -- b 是 Coroutine 对象
end
```

> **注意**：
>
> - **`b` 是 `Coroutine` 对象**，`StopCoroutine` 接受 `Coroutine` 或 `IEnumerator`。
> - 若传入 `IEnumerator`，需确保其未被释放。
---

## 四、C# 脚本示例（LuaCallCsharp）

```csharp
using UnityEngine;

public class LuaCallCsharp : MonoBehaviour{}
```
