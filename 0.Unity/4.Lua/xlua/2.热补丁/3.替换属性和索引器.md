[toc]

# 替换属性和索引器

> 场景：已经在 C# 端给类打了 `[Hotfix]`，现在需要把**属性 get/set**以及**索引器 this[…]**的逻辑完全搬到 Lua 中。

---

## 一、C# 原始代码

```csharp
[Hotfix]
public class HotfixMain : MonoBehaviour
{
    public int Age { get => 0; set => Debug.Log(value); }

    private int[] array = { 1, 2, 3 };

    // 索引器
    public int this[int index]
    {
        get
        {
            if (index < 0 || index >= array.Length) return 0;
            return array[index];
        }
        set
        {
            if (index < 0 || index >= array.Length) return;
            array[index] = value;
        }
    }

    void Start()
    {
        Age = 100;          // set
        print(Age);         // get

        this[99] = 999;     // set_Item
        print(this[99]);    // get_Item
    }
}
```

---

## 二、Lua 热补丁代码

```lua
print("**********替换属性和索引器**********")

xlua.hotfix(CS.Study.HotfixMain, {
    --======== 属性 =========--
    set_Age = function(self, value)
        print("Lua重定向属性" .. value)
    end,
    get_Age = function(self)
        return 10          -- 永远返回 10
    end,

    --======== 索引器 =========--
    -- 固定写法：set_Item / get_Item
    set_Item = function(self, index, value)
        print("Lua重定向索引器" .. index .. "/" .. value)
    end,
    get_Item = function(self, index)
        print("Lua重定向索引器")
        return 999         -- 永远返回 999
    end
})
```

---

## 三、 xLua 命名规则速查

| C# 语法                           | 对应 Lua 键名           | 参数列表                                          |
| --------------------------------- | ----------------------- | ------------------------------------------------- |
| `int Age { get; set; }`           | `get_Age` / `set_Age`   | get: `(self)`；set: `(self, value)`               |
| `int this[int idx] { get; set; }` | `get_Item` / `set_Item` | get: `(self, index)`；set: `(self, index, value)` |

> 索引器只能**按固定名字** `get_Item` / `set_Item` 打补丁，**无法**对多参数索引器（如 `this[int, string]`）直接使用，需要额外生成代码或封装方法。

---

## 四、运行效果对比

| 操作              | 原 C# 逻辑       | 打补丁后 Lua 逻辑                     |
| ----------------- | ---------------- | ------------------------------------- |
| `Age = 100`       | `Debug.Log(100)` | 打印 `"Lua重定向属性100"`             |
| `print(Age)`      | `0`              | `10`                                  |
| `this[99] = 999`  | 边界检查→return  | 打印 `"Lua重定向索引器99/999"`        |
| `print(this[99])` | `0`              | 打印 `"Lua重定向索引器"` 并返回 `999` |

---

## 五、常见坑

1. 名字打错  
   大小写敏感，必须是 `get_PropName` / `set_PropName`，否则补丁不生效且不会报错。
2. 索引器重载  
   若存在 **多参数** 索引器（如 `this[int, string]`），xLua 默认只能识别 **单参数** 版本；需要改走方法封装或拆分。
3. 注入失败  
   新增/修改了属性或索引器后，务必重新  
   `Generate Code` → `Hotfix Inject In Editor`，否则补丁不会生效。
