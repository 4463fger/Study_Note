[toc]

# 事件加减重定向

> 目标：把 C# 端 `event Action myEvent` 的 `+=` 与 `-=` 操作完全搬到 Lua，实现“监听/取消监听”时的自定义逻辑。

---

## 一、C# 原始代码

```csharp
[Hotfix]
public class HotfixMain : MonoBehaviour
{
    private event UnityAction myEvent;   // 普通事件

    void Start()
    {
        myEvent += Test;
        myEvent -= Test;
        myEvent?.Invoke();
    }

    void Test() => Debug.Log("原逻辑");
}
```

---

## 二、Lua 热补丁代码

```lua
print("**********事件加减替换**********")

xlua.hotfix(CS.Study.HotfixMain, {
    -- 事件加
    add_myEvent = function(self, handler)
        print("添加事件函数")
        -- 绝对不能：self:myEvent("+", handler) 会死循环！
        -- 这里只是演示，不真正存储 handler
    end,

    -- 事件减
    remove_myEvent = function(self, handler)
        print("移除事件函数")
        -- 同样不能：self:myEvent("-", handler)
    end
})
```

---

## 三、 xLua 命名规则

| C# 事件声明            | Lua 键名                         | 参数列表           |
| ---------------------- | -------------------------------- | ------------------ |
| `event Action myEvent` | `add_myEvent` / `remove_myEvent` | `(self, delegate)` |

> - add_事件名
> - 事件名必须与 C# 字段名完全一致（区分大小写）

## 四、重要警告

1. **不要在重定向里再操作事件本身**  
   以下写法会**无限递归**：
   
   ```lua
   self:myEvent("+", handler)   -- × 死循环！
   ```
   原因：`add_myEvent` 本身就会被 `+=` 触发。
   
2. **Lua 侧若需真正存储/触发事件**，请：
   - 在 Lua 本地 `local luaListeners = {}` 手动维护列表；
   - 或者在 C# 再开一个 `List<UnityAction>` 字段供 Lua 读写，避开原事件

## 五、小结

| 要点           | 结论                            |
| -------------- | ------------------------------- |
| 事件重定向键名 | `add_事件名` / `remove_事件名`  |
| 参数           | `(self, delegate)`              |
| 禁忌           | 在重定向内再次 `+= / -=` 原事件 |
| 真·存储        | Lua 自建表或 C# 辅助字段        |
